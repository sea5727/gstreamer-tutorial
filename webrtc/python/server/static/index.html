<!DOCTYPE html>
<html>

<head>
  <title>gstreamer webrtcbin client</title>
</head>

<body>
  <h1>Realtime communication with WebRTC</h1>

  <video id="localVideo" autoplay playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div>
    <button id="startButton">start</button>
    <button id="offerButton">offer</button>
  </div>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <script>
    let ws = null
    
    const localVideo = document.getElementById('localVideo');
    const startButton = document.getElementById('startButton')
    const offerButton = document.getElementById('offerButton')
    
    let localStream = null
    

    const mediaStreamConstraints = {
      audio: true,
      video: true,
    };

    const offerOptions = {
      offerToReceiveVideo: 1,
      offerToReceiveAudio: 1,
    };

    startAction = async () => {
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia(mediaStreamConstraints)
        localVideo.srcObject = mediaStream
        localStream = mediaStream      
      } catch(error){
        console.error(error.toString())
      }
    }

    startOffer = async () => {
      const videoTracks = localStream.getVideoTracks()
      const audioTracks = localStream.getAudioTracks()
      if (videoTracks.length > 0) {
        console.log(`Using video device: ${videoTracks[0].label}.`)
      }
      if(audioTracks.length > 0) {
        console.log(`Using audio device: ${audioTracks[0].label}.`)
      }

      const servers = null
      const config = {
        'iceServers' : [{
          urls : 'stun:18.191.223.12:3478'
        }]
      }

      localPeerConnection = new RTCPeerConnection(config);
      localPeerConnection.addEventListener('icecandidate', (event) => {
        const peerConnection = event.target

        if (event.candidate && ws) {
          // const iceCandidate = new RTCIceCandidate(event.candidate)
          console.log('event.candidate:', event.candidate.candidate)
          
          message = {
            event : {
              type : 'ice',
              candidate : event.candidate.candidate,
              sdpMLineIndex: event.candidate.sdpMLineIndex,
            }
          }
          ws.send(JSON.stringify(message))
        }

      });
      localPeerConnection.addStream(localStream);
      try{

        ws = new WebSocket("wss://192.168.0.59:8999/webrtc");
        ws.onopen = async () => {
          description = await localPeerConnection.createOffer(offerOptions)
          await localPeerConnection.setLocalDescription(description)
          message = {
            request : {
              type : 'offer',
              sdp : localPeerConnection.localDescription.sdp,
            }
          }
          ws.send(JSON.stringify(message))
        }
        ws.onmessage = async (event) => {
          console.log('event.data:', event.data)
          res_msg = JSON.parse(event.data)
          if(res_msg.response){
            if(res_msg.response.type == 'answer'){
              description = new RTCSessionDescription({ type : 'answer', sdp : res_msg.response.sdp})
              await localPeerConnection.setRemoteDescription(description)
              console.log('setRemoteDescription success')
            }
          }
        }
      } catch (error) {
        console.error(error.toString())
      }
    }

    startButton.addEventListener('click', startAction);
    offerButton.addEventListener('click', startOffer);

  </script>
</body>

</html>